<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ibenben.mapper.GoodsMapper">
  <cache type="com.ibenben.redis.MybatisRedisCache"/>
  <resultMap id="BaseResultMap" type="com.ibenben.domain.Goods">
    <id column="goods_id" jdbcType="BIGINT" property="goodsId" />
    <id column="platform_id" jdbcType="INTEGER" property="platformId" />
    <id column="merchant_id" jdbcType="INTEGER" property="merchantId" />
    <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
    <result column="platform_name" jdbcType="VARCHAR" property="platformName" />
    <result column="merchant_name" jdbcType="VARCHAR" property="merchantName" />
    <result column="created_user" jdbcType="VARCHAR" property="createdUser" />
    <result column="created_time" jdbcType="TIMESTAMP" property="createdTime" />
    <result column="shop_id" jdbcType="INTEGER" property="shopId" />
  </resultMap>
  <resultMap id="GoodsProductResultMap" type="com.ibenben.domain.Goods" extends="BaseResultMap">
  	<association property="product" javaType="com.ibenben.domain.Product">
  		<result column="product_id" jdbcType="INTEGER" property="productId"/>
    	<result column="product_name" jdbcType="VARCHAR" property="productName" />
  	</association>
  </resultMap>
  <sql id="Base_Column_List">
    goods_id, platform_id, merchant_id, goods_name, created_user, created_time,shop_id
  </sql>
  <sql id="Goods_Product_list">
  	g.*, p.product_id, p.product_name
  </sql>
  <sql id="Where_Clouse">
	  <where>
		    <if test = "goods_id != null and goods_id != '' ">
		    	g.goods_id = #{goods_id,jdbcType=INTEGER}
		    </if>
		    <if test = "platform_id != null and platform_id != '' ">
		    	and g.platform_id = #{platform_id,jdbcType=INTEGER}
		    </if>
		    <if test = "merchant_id != null and merchant_id != '' ">
		    	and g.merchant_id = #{merchant_id,jdbcType=INTEGER}
		    </if>
		    <if test = "goods_name != null and goods_name != '' ">
		    	and g.goods_name like concat('%',#{goods_name,jdbcType=VARCHAR},'%')
		    </if>
		    <if test = "created_user != null and created_user != '' ">
		    	and g.created_user = #{created_user,jdbcType=VARCHAR}
		    </if>
		    <if test = "start_time != null and start_time != '' ">
		    	and g.created_time &gt;= #{start_time,jdbcType=TIMESTAMP}
		    </if>
		    <if test = "end_time != null and end_time != '' ">
		    	and g.created_time &lt;= #{end_time,jdbcType=TIMESTAMP}
		    </if>
		    <if test = "product_id != null and product_id != '' ">
		    	and p.product_id = #{product_id,jdbcType=INTEGER}
		    </if>
		    <if test = "product_name != null and product_name != '' ">
		    	and p.product_name like concat('%',#{product_name,jdbcType=VARCHAR},'%')
		    </if>
	    </where>
  </sql>
  
  <select id="isExist" parameterType="java.util.Map" resultType="java.lang.Integer">
    select count(goods_id)
    from goods
    where
    goods_id = #{goods_id,jdbcType=BIGINT} and
    platform_id = #{platform_id,jdbcType=INTEGER}
  </select>
  
  <delete id="delGoods" parameterType="java.util.Map">
    delete
    from goods
    where
    goods_id = #{goods_id,jdbcType=BIGINT} and
    platform_id = #{platform_id,jdbcType=INTEGER}
  </delete>
  
  <insert id="upsertGoods" parameterType="java.util.Map">
    insert into goods
    (goods_id,goods_name,platform_id,shop_id,created_user,created_time,merchant_id)
    values
    (#{goods_id,jdbcType=BIGINT},#{goods_name,jdbcType=VARCHAR},#{platform_id,jdbcType=INTEGER},#{shop_id,jdbcType=INTEGER},
    #{created_user,jdbcType=VARCHAR},#{created_time,jdbcType=TIMESTAMP},#{merchant_id,jdbcType=INTEGER})
  </insert>
  
  <select id="selectByPrimaryKey" parameterType="com.ibenben.domain.GoodsKey" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from goods
    where goods_id = #{goodsId,jdbcType=BIGINT}
      and platform_id = #{platformId,jdbcType=INTEGER}
      and merchant_id = #{merchantId,jdbcType=INTEGER}
  </select>
  
  <select id="selectByMapParams" parameterType="java.util.Map" resultMap="BaseResultMap">
   	select 
    <include refid="Base_Column_List" />
    from goods g
    <include refid="Where_Clouse"></include>
  </select>
  
  <select id="selectIdAndNames" parameterType="java.util.Map" resultType="java.util.Map">
  	select 
    	goods_id,
    	goods_name
    from goods g
    <include refid="Where_Clouse"></include>
  </select>
  
  <select id="selectGoodsProductByMapParams" parameterType="java.util.Map" resultMap="GoodsProductResultMap">
   	select 
    <include refid="Goods_Product_list" />
     from goods g
	LEFT JOIN product_goods_mapping pgm on g.goods_id = pgm.goods_id
	LEFT JOIN product p on pgm.product_id = p.product_id
    <include refid="Where_Clouse"></include>
  </select>
  
  <select id="selectUnMappedGoods" resultMap="GoodsProductResultMap">
	select
	g.*,m.merchant_name, pf.platform_name,p.product_id, p.product_name
	from goods g
	left join product_goods_mapping pgm on g.goods_id = pgm.goods_id and pgm.status='OK'
	left join product p on pgm.product_id = p.product_id and p.status='OK'
	left join merchant m on g.merchant_id = m.merchant_id and m.status='OK'
	left join platform pf on pf.platform_id = g.platform_id and pf.status='OK'
	where p.product_id is null
	<if test="goods_id != null and goods_id != ''">
		and g.goods_id = #{goods_id,jdbcType=INTEGER}
	</if>
	<if test="platform_id != null and platform_id != '' ">
		and g.platform_id = #{platform_id,jdbcType=INTEGER}
	</if>
	<if test="merchant_id != null and merchant_id != '' ">
		and g.merchant_id = #{merchant_id,jdbcType=INTEGER}
	</if>
	 group by g.goods_id
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="com.ibenben.domain.GoodsKey">
    delete from goods
    where goods_id = #{goodsId,jdbcType=BIGINT}
      and platform_id = #{platformId,jdbcType=INTEGER}
      and merchant_id = #{merchantId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.ibenben.domain.Goods">
    insert into goods (goods_id, platform_id, merchant_id, 
      goods_name, created_user, created_time,shop_id
      )
    values (#{goodsId,jdbcType=BIGINT}, #{platformId,jdbcType=INTEGER}, #{merchantId,jdbcType=INTEGER}, 
      #{goodsName,jdbcType=VARCHAR}, #{createdUser,jdbcType=VARCHAR}, #{createdTime,jdbcType=TIMESTAMP},
      #{shopId,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.ibenben.domain.Goods">
    insert into goods
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="goodsId != null">
        goods_id,
      </if>
      <if test="platformId != null">
        platform_id,
      </if>
      <if test="merchantId != null">
        merchant_id,
      </if>
      <if test="goodsName != null">
        goods_name,
      </if>
      <if test="createdUser != null">
        created_user,
      </if>
      <if test="createdTime != null">
        created_time,
      </if>
      <if test="shopId != null">
        shop_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="goodsId != null">
        #{goodsId,jdbcType=BIGINT},
      </if>
      <if test="platformId != null">
        #{platformId,jdbcType=INTEGER},
      </if>
      <if test="merchantId != null">
        #{merchantId,jdbcType=INTEGER},
      </if>
      <if test="goodsName != null">
        #{goodsName,jdbcType=VARCHAR},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null">
        #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shopId != null">
        #{shopId,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.ibenben.domain.Goods">
    update goods
    <set>
      <if test="goodsName != null">
        goods_name = #{goodsName,jdbcType=VARCHAR},
      </if>
      <if test="createdUser != null">
        created_user = #{createdUser,jdbcType=VARCHAR},
      </if>
      <if test="createdTime != null">
        created_time = #{createdTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shopId != null">
        shop_id = #{shopId,jdbcType=INTEGER}
      </if>
    </set>
    where goods_id = #{goodsId,jdbcType=BIGINT}
      and platform_id = #{platformId,jdbcType=INTEGER}
      and merchant_id = #{merchantId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.ibenben.domain.Goods">
    update goods
    set goods_name = #{goodsName,jdbcType=VARCHAR},
      created_user = #{createdUser,jdbcType=VARCHAR},
      created_time = #{createdTime,jdbcType=TIMESTAMP},
      shop_id = #{shopId,jdbcType=INTEGER}
    where goods_id = #{goodsId,jdbcType=BIGINT}
      and platform_id = #{platformId,jdbcType=INTEGER}
      and merchant_id = #{merchantId,jdbcType=INTEGER}
  </update>
</mapper>